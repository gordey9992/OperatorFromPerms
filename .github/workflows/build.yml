name: ðŸ—ï¸ Build OperatorFromPerms

on:
  push:
    branches: [ "main", "master", "development" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
    inputs:
      version:
        description: 'Ð’ÐµÑ€ÑÐ¸Ñ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸'
        required: false
        default: 'auto'

env:
  PLUGIN_NAME: OperatorFromPerms
  JAVA_VERSION: '21'

jobs:
  validate:
    name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð°
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸš¨ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ YAML
      uses: actions/desktop/yml-validator@v1
      with:
        file: src/main/resources/plugin.yml
    
    - name: ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
      run: |
        echo "ðŸ”Ž ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
        [ -f "pom.xml" ] || echo "âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ pom.xml"
        [ -f "src/main/resources/plugin.yml" ] || echo "âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ plugin.yml"
        [ -f "src/main/resources/config.yml" ] || echo "âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ config.yml"
        [ -f "src/main/resources/messages.yml" ] || echo "âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ messages.yml"
        [ -d "src/main/java/com/gordey9992/operatorfromperms" ] || echo "âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ ÐºÐ¾Ð´"
        echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"

  build:
    name: ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°
    runs-on: ubuntu-latest
    needs: validate
    
    strategy:
      matrix:
        java: [ '21' ]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java }}
        distribution: 'temurin'
        cache: 'maven'
    
    - name: ðŸ“Š Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ
      run: |
        echo "ðŸ”„ ÐÐ°Ñ‡Ð°Ð»Ð¾ ÑÐ±Ð¾Ñ€ÐºÐ¸ ${{ env.PLUGIN_NAME }}"
        echo "ðŸ“… Ð”Ð°Ñ‚Ð°: $(date)"
        echo "â˜• Java: ${{ matrix.java }}"
        echo "ðŸ·ï¸  Git commit: ${{ github.sha }}"
        echo "ðŸŽ¯ Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref }}"
    
    - name: ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… ÑÐ±Ð¾Ñ€Ð¾Ðº
      run: mvn -B clean
    
    - name: ðŸ“¦ ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ ÐºÐ¾Ð´Ð°
      run: mvn -B compile
      
    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: mvn -B dependency:tree
      
    - name: ðŸ› ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° JAR
      run: mvn -B package -DskipTests
      
    - name: ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° JAR
      run: |
        JAR_FILE=$(ls target/*.jar)
        echo "ðŸ“¦ Ð¤Ð°Ð¹Ð»: $JAR_FILE"
        echo "ðŸ“Š Ð Ð°Ð·Ð¼ÐµÑ€: $(du -h $JAR_FILE | cut -f1)"
        echo "ðŸ” MD5: $(md5sum $JAR_FILE | cut -d' ' -f1)"
        
    - name: ðŸ“‹ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼ Ð¿Ð»Ð°Ð³Ð¸Ð½Ðµ
      run: |
        JAR_FILE=$(ls target/*.jar)
        echo "ðŸŽ‰ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
        echo "ðŸ“ Ð¤Ð°Ð¹Ð»: $JAR_FILE"
        echo "ðŸ’¾ Ð Ð°Ð·Ð¼ÐµÑ€: $(du -h $JAR_FILE | cut -f1)"
        unzip -p $JAR_FILE plugin.yml | head -10

  quality:
    name: âœ… ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð¸Ð»Ñ ÐºÐ¾Ð´Ð°
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° code style..."
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ€ÑƒÑÑÐºÐ¸Ñ… ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ²
        find src/main/java -name "*.java" -exec grep -l "TODO\|FIXME" {} \; | while read file; do
          echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½ TODO/FIXME Ð²: $file"
        done
        
    - name: ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¾Ð²
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²Ð°Ð»Ð¸Ð´Ð½Ð¾ÑÑ‚ÑŒ YAML
        python3 -c "
        import yaml
        try:
            with open('src/main/resources/plugin.yml', 'r') as f:
                yaml.safe_load(f)
            print('âœ… plugin.yml - OK')
        except Exception as e:
            print(f'âŒ plugin.yml - ERROR: {e}')
            
        try:
            with open('src/main/resources/config.yml', 'r') as f:
                yaml.safe_load(f)
            print('âœ… config.yml - OK')
        except Exception as e:
            print(f'âŒ config.yml - ERROR: {e}')
            
        try:
            with open('src/main/resources/messages.yml', 'r') as f:
                yaml.safe_load(f)
            print('âœ… messages.yml - OK')
        except Exception as e:
            print(f'âŒ messages.yml - ERROR: {e}')
        " || echo "ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° YAML Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð° (Python Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½)"

  artifacts:
    name: ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
    runs-on: ubuntu-latest
    needs: [build, quality]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: ðŸ—ï¸ Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ°
      run: mvn -B clean package -DskipTests
      
    - name: ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
        mkdir -p artifacts
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ JAR
        cp target/*.jar artifacts/
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸
        cp src/main/resources/*.yml artifacts/
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README Ð´Ð»Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
        cat > artifacts/README.txt << EOF
        OperatorFromPerms - ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸
        ===================================
        
        Ð¡Ð±Ð¾Ñ€ÐºÐ°: ${{ github.run_number }}
        ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}
        Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref }}
        Ð”Ð°Ñ‚Ð°: $(date)
        
        Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ:
        - *.jar - Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð»Ð°Ð³Ð¸Ð½
        - *.yml - ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
        
        Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:
        1. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ JAR Ñ„Ð°Ð¹Ð» Ð² Ð¿Ð°Ð¿ÐºÑƒ plugins/
        2. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ ÑÐµÑ€Ð²ÐµÑ€
        3. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸ Ð² plugins/OperatorFromPerms/
        
        Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸:
        - gordey25690
        - DeepSeek
        EOF
        
        echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸ artifacts:"
        ls -la artifacts/
    
    - name: ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
      uses: actions/upload-artifact@v4
      with:
        name: OperatorFromPerms-Build-${{ github.run_number }}
        path: |
          artifacts/*.jar
          artifacts/*.yml
          artifacts/README.txt
        retention-days: 90

  notify:
    name: ðŸ“¢ Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
    runs-on: ubuntu-latest
    needs: [artifacts]
    if: always()
    
    steps:
    - name: ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐ±Ð¾Ñ€ÐºÐ¸
      run: |
        if [ "${{ needs.artifacts.result }}" == "success" ]; then
          echo "ðŸŽ‰ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð£Ð¡ÐŸÐ•Ð¨ÐÐ!"
          echo "ðŸ“¦ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð²Ð¾ Ð²ÐºÐ»Ð°Ð´ÐºÐµ Actions"
        else
          echo "âŒ Ð¡Ð±Ð¾Ñ€ÐºÐ° ÐŸÐ ÐžÐ’ÐÐ›Ð•ÐÐ!"
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹"
        fi
        
    - name: ðŸ“ Ð¡Ð²Ð¾Ð´ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸
      run: |
        echo "# ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° OperatorFromPerms" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð°: ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ°: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY  
        echo "- âœ… ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾: ${{ needs.quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹: ${{ needs.artifacts.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹:" >> $GITHUB_STEP_SUMMARY
        echo "Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð»Ð°Ð³Ð¸Ð½ Ð²Ð¾ Ð²ÐºÐ»Ð°Ð´ÐºÐµ **Actions** â†’ **Artifacts**" >> $GITHUB_STEP_SUMMARY
