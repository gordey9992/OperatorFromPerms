name: ðŸ—ï¸ Build OperatorFromPerms

on:
  push:
    branches: [ "main", "master", "development" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
    inputs:
      version:
        description: 'Ð’ÐµÑ€ÑÐ¸Ñ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸'
        required: false
        default: 'auto'

env:
  PLUGIN_NAME: OperatorFromPerms
  JAVA_VERSION: '21'

jobs:
  validate:
    name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð°
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
      run: |
        echo "ðŸ”Ž ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
        REQUIRED_FILES=("pom.xml" "src/main/resources/plugin.yml" "src/main/resources/config.yml" "src/main/resources/messages.yml")
        REQUIRED_DIRS=("src/main/java/com/gordey9992/operatorfromperms")
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file - Ð½Ð°Ð¹Ð´ÐµÐ½"
          else
            echo "âŒ $file - ÐžÐ¢Ð¡Ð£Ð¢Ð¡Ð¢Ð’Ð£Ð•Ð¢"
            exit 1
          fi
        done
        
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [ -d "$dir" ]; then
            echo "âœ… $dir - Ð½Ð°Ð¹Ð´ÐµÐ½"
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÐµÑÑ‚ÑŒ java Ñ„Ð°Ð¹Ð»Ñ‹
            JAVA_FILES=$(find "$dir" -name "*.java" | wc -l)
            echo "ðŸ“ ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Java Ñ„Ð°Ð¹Ð»Ð¾Ð²: $JAVA_FILES"
          else
            echo "âŒ $dir - ÐžÐ¢Ð¡Ð£Ð¢Ð¡Ð¢Ð’Ð£Ð•Ð¢"
            exit 1
          fi
        done
        
        echo "âœ… Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð² Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ!"

  build:
    name: ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: ðŸ“Š Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ
      run: |
        echo "ðŸ”„ ÐÐ°Ñ‡Ð°Ð»Ð¾ ÑÐ±Ð¾Ñ€ÐºÐ¸ ${{ env.PLUGIN_NAME }}"
        echo "ðŸ“… Ð”Ð°Ñ‚Ð°: $(date)"
        echo "â˜• Java: 21"
        echo "ðŸ·ï¸ Git commit: ${{ github.sha }}"
        echo "ðŸŽ¯ Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref }}"
        echo "ðŸ‘¤ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ñ‚Ð¾Ñ€: ${{ github.actor }}"
    
    - name: ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… ÑÐ±Ð¾Ñ€Ð¾Ðº
      run: mvn -B clean
    
    - name: ðŸ“¦ ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ ÐºÐ¾Ð´Ð°
      run: mvn -B compile
      
    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: mvn -B dependency:tree
      
    - name: ðŸ› ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° JAR
      run: mvn -B package -DskipTests
      
    - name: ðŸ“ ÐÐ½Ð°Ð»Ð¸Ð· ÑÐ±Ð¾Ñ€ÐºÐ¸
      run: |
        JAR_FILE=$(ls target/*.jar 2>/dev/null | head -1)
        if [ -f "$JAR_FILE" ]; then
          echo "ðŸŽ‰ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð£Ð¡ÐŸÐ•Ð¨ÐÐ!"
          echo "ðŸ“¦ Ð¤Ð°Ð¹Ð»: $JAR_FILE"
          echo "ðŸ“Š Ð Ð°Ð·Ð¼ÐµÑ€: $(du -h "$JAR_FILE" | cut -f1)"
          echo "ðŸ” MD5: $(md5sum "$JAR_FILE" | cut -d' ' -f1)"
          echo "ðŸ“ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð»Ð°Ð³Ð¸Ð½Ðµ:"
          unzip -p "$JAR_FILE" plugin.yml 2>/dev/null | grep -E "(name|version|main|api-version)" || echo "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ plugin.yml"
        else
          echo "âŒ Ð¡Ð±Ð¾Ñ€ÐºÐ° ÐŸÐ ÐžÐ’ÐÐ›Ð•ÐÐ - JAR Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          exit 1
        fi

  quality:
    name: âœ… ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° code style
      run: |
        echo "ðŸ” ÐÐ½Ð°Ð»Ð¸Ð· ÐºÐ¾Ð´Ð°..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ TODO/FIXME
        echo "ðŸ“‹ ÐŸÐ¾Ð¸ÑÐº TODO/FIXME:"
        find src/main/java -name "*.java" -exec grep -l "TODO\|FIXME" {} \; | while read file; do
          echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½ Ð²: $file"
          grep -n "TODO\|FIXME" "$file"
        done
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÑƒÑÑÐºÐ¸Ðµ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸
        echo "ðŸ”¤ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ²:"
        JAVA_FILES_COUNT=$(find src/main/java -name "*.java" | wc -l)
        echo "ðŸ“ Ð’ÑÐµÐ³Ð¾ Java Ñ„Ð°Ð¹Ð»Ð¾Ð²: $JAVA_FILES_COUNT"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ Java
        echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ° Java..."
        mvn -B compile > /dev/null 2>&1 && echo "âœ… Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ Java - OK" || echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ¸ Ð² ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐµ Java"
        
    - name: ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¹
      run: |
        echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° YAML Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
        
        # ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° plugin.yml
        if grep -q "name:" src/main/resources/plugin.yml && \
           grep -q "version:" src/main/resources/plugin.yml && \
           grep -q "main:" src/main/resources/plugin.yml; then
          echo "âœ… plugin.yml - Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚"
        else
          echo "âŒ plugin.yml - Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ"
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸ Ð½Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ðµ
        for config in src/main/resources/*.yml; do
          if [ -s "$config" ]; then
            echo "âœ… $(basename "$config") - Ð½Ðµ Ð¿ÑƒÑÑ‚Ð¾Ð¹"
          else
            echo "âŒ $(basename "$config") - ÐŸÐ£Ð¡Ð¢ÐžÐ™!"
          fi
        done

  artifacts:
    name: ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
    runs-on: ubuntu-latest
    needs: [build, quality]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: ðŸ—ï¸ Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ°
      run: mvn -B clean package -DskipTests
      
    - name: ðŸ“ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
        mkdir -p artifacts
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ JAR
        JAR_FILE=$(ls target/*.jar)
        cp "$JAR_FILE" artifacts/
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸
        cp src/main/resources/*.yml artifacts/
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ
        cat > artifacts/build-info.txt << EOF
        OperatorFromPerms - Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ
        ======================================
        
        ÐÐ¾Ð¼ÐµÑ€ ÑÐ±Ð¾Ñ€ÐºÐ¸: ${{ github.run_number }}
        ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}
        Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}
        Ð”Ð°Ñ‚Ð°: $(date)
        
        Ð¤Ð°Ð¹Ð»Ñ‹:
        - $(basename "$JAR_FILE") - Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð»Ð°Ð³Ð¸Ð½
        - config.yml - ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
        - messages.yml - Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
        - plugin.yml - ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°
        
        Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:
        1. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ JAR Ñ„Ð°Ð¹Ð» Ð² Ð¿Ð°Ð¿ÐºÑƒ plugins/
        2. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ ÑÐµÑ€Ð²ÐµÑ€
        3. ÐšÐ¾Ð½Ñ„Ð¸Ð³Ð¸ ÑÐ¾Ð·Ð´Ð°Ð´ÑƒÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
        
        ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹:
        /opf reload - Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸
        /opf check <Ð¸Ð³Ñ€Ð¾Ðº> - Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ
        
        Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸:
        - gordey25690
        - DeepSeek
        EOF
        
        echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸ artifacts:"
        ls -la artifacts/
        echo ""
        echo "ðŸ“Š Ð Ð°Ð·Ð¼ÐµÑ€Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
        du -h artifacts/*
    
    - name: ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
      uses: actions/upload-artifact@v4
      with:
        name: OperatorFromPerms-v${{ github.run_number }}
        path: artifacts/
        retention-days: 30

  notify:
    name: ðŸ“¢ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸
    runs-on: ubuntu-latest
    needs: [artifacts]
    if: always()
    
    steps:
    - name: ðŸ“Š Ð¡Ð²Ð¾Ð´ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
      run: |
        echo "ðŸŽ¯ Ð¡Ð‘ÐžÐ ÐšÐ Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ˆ Ð¡Ñ‚Ð°Ñ‚ÑƒÑÑ‹ Ð·Ð°Ð´Ð°Ð½Ð¸Ð¹:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ | Ð¡Ñ‚Ð°Ñ‚ÑƒÑ |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð° | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY  
        echo "| âœ… ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¦ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ | ${{ needs.artifacts.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.artifacts.result }}" == "success" ]; then
          echo "## ðŸŽ‰ Ð£Ð¡ÐŸÐ•Ð¥!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÐ»Ð°Ð³Ð¸Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð±Ñ€Ð°Ð½!" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ÐšÐ°Ðº Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ:" >> $GITHUB_STEP_SUMMARY
          echo "1. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð²Ð¾ Ð²ÐºÐ»Ð°Ð´ÐºÑƒ **Actions**" >> $GITHUB_STEP_SUMMARY
          echo "2. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÑ‚Ñƒ ÑÐ±Ð¾Ñ€ÐºÑƒ" >> $GITHUB_STEP_SUMMARY
          echo "3. Ð’ Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ **Artifacts** ÑÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ `OperatorFromPerms-v${{ github.run_number }}`" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Ð¡Ð‘ÐžÐ ÐšÐ ÐŸÐ ÐžÐ’ÐÐ›Ð•ÐÐ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð´Ð»Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð¾: $(date)*" >> $GITHUB_STEP_SUMMARY
