name: Build OperatorFromPerms

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Тип сборки'
        required: true
        default: 'release'
        type: choice
        options:
        - 'release'
        - 'snapshot'
        - 'test'

env:
  PLUGIN_NAME: OperatorFromPerms
  JAVA_VERSION: '21'

jobs:
  validate:
    name: Проверка проекта
    runs-on: ubuntu-latest
    steps:
    - name: Получить код
      uses: actions/checkout@v4

    - name: Проверить структуру
      run: |
        echo "Проверка файлов проекта..."
        files=("pom.xml" "src/main/resources/plugin.yml" "src/main/resources/config.yml" "src/main/resources/messages.yml")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "OK: $file"
          else
            echo "ERROR: $file не найден"
            exit 1
          fi
        done

        echo "Проверка исходного кода..."
        if [ -d "src/main/java/com/gordey9992/operatorfromperms" ]; then
          java_files=$(find src/main/java/com/gordey9992/operatorfromperms -name "*.java" | wc -l)
          echo "Найдено Java файлов: $java_files"
        else
          echo "ERROR: Папка с исходным кодом не найдена"
          exit 1
        fi

  build:
    name: Сборка плагина
    runs-on: ubuntu-latest
    needs: validate

    steps:
    - name: Получить код
      uses: actions/checkout@v4

    - name: Установить Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: Собрать проект
      run: mvn -B clean package -DskipTests

    - name: Проверить результат
      run: |
        jar_file=$(find target -name "*.jar" ! -name "*-javadoc.jar" ! -name "original-*.jar" | head -1)
        if [ -f "$jar_file" ]; then
          echo "Сборка успешна"
          echo "Файл: $jar_file"
          echo "Размер: $(du -h "$jar_file" | cut -f1)"
        else
          echo "Сборка не удалась"
          exit 1
        fi

  test:
    name: Тестирование
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Получить код
      uses: actions/checkout@v4

    - name: Установить Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Запустить тесты
      run: mvn -B test

  quality:
    name: Проверка качества
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Получить код
      uses: actions/checkout@v4

    - name: Проверить код
      run: |
        echo "Проверка качества кода..."
        echo "Количество Java файлов: $(find src/main/java -name "*.java" | wc -l)"
        echo "Количество YAML файлов: $(find src/main/resources -name "*.yml" | wc -l)"
        
        echo "Поиск TODO и FIXME:"
        find src/main/java -name "*.java" -exec grep -l "TODO\|FIXME" {} \; | while read file; do
          echo "Найдено в: $file"
        done

  artifacts:
    name: Создание артефактов
    runs-on: ubuntu-latest
    needs: [build, quality]
    
    steps:
    - name: Получить код
      uses: actions/checkout@v4

    - name: Установить Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Финальная сборка
      run: mvn -B clean package -DskipTests

    - name: Подготовить артефакты
      run: |
        mkdir -p artifacts
        jar_file=$(find target -name "*.jar" ! -name "*-javadoc.jar" ! -name "original-*.jar" | head -1)
        cp "$jar_file" artifacts/
        cp src/main/resources/*.yml artifacts/ 2>/dev/null || echo "Конфиги скопированы"

        cat > artifacts/info.txt << 'EOF'
OperatorFromPerms - Собранный плагин
Версия: 2.0.0
Дата сборки: $(date)
Коммит: ${{ github.sha }}
Ветка: ${{ github.ref_name }}

Функции:
- Выдача прав оператора через LuckPerms
- Система авторизации
- Команды управления

Разработчики:
- gordey25690
- DeepSeek
EOF

    - name: Загрузить артефакты
      uses: actions/upload-artifact@v4
      with:
        name: OperatorFromPerms-Build-${{ github.run_number }}
        path: artifacts/
        retention-days: 30

  release:
    name: Создание релиза
    runs-on: ubuntu-latest
    needs: [build, test, quality, artifacts]
    if: github.ref == 'refs/heads/main' && inputs.build_type == 'release'

    steps:
    - name: Создать релиз
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*
        generate_release_notes: true
        tag_name: v2.0.0-${{ github.run_number }}
        name: "OperatorFromPerms v2.0.0"

  report:
    name: Итоговый отчет
    runs-on: ubuntu-latest
    needs: [validate, build, test, quality, artifacts]
    if: always()

    steps:
    - name: Создать отчет
      run: |
        echo "Результаты сборки #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Этап | Статус |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Проверка проекта | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Сборка плагина | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Тестирование | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Проверка качества | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Создание артефактов | ${{ needs.artifacts.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.artifacts.result }}" == "success" ]; then
          echo "Сборка завершена успешно!" >> $GITHUB_STEP_SUMMARY
          echo "Артефакты готовы к скачиванию." >> $GITHUB_STEP_SUMMARY
        else
          echo "В процессе сборки возникли ошибки." >> $GITHUB_STEP_SUMMARY
        fi
