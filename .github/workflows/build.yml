name: Build OperatorFromPerms v2

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      enable_tests:
        description: '–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã'
        required: false
        default: 'false'

env:
  PLUGIN_NAME: OperatorFromPerms
  PLUGIN_VERSION: 2.0.0
  JAVA_VERSION: '21'

jobs:
  security-check:
    name: üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4
        
      - name: üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
        run: |
          echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞..."
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã..."
          [ -f "src/main/java/com/gordey9992/operatorfromperms/AuthManager.java" ] && echo "‚úÖ AuthManager –Ω–∞–π–¥–µ–Ω" || echo "‚ùå AuthManager –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
          echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π..."
          grep -q "SHA-256" src/main/java/com/gordey9992/operatorfromperms/AuthManager.java && echo "‚úÖ –ü–∞—Ä–æ–ª–∏ —Ö—ç—à–∏—Ä—É—é—Ç—Å—è" || echo "‚ö†Ô∏è  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π"

  build:
    name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø–ª–∞–≥–∏–Ω–∞
    runs-on: ubuntu-latest
    needs: security-check
    
    strategy:
      matrix:
        java: [ '21' ]
        os: [ 'ubuntu-latest' ]
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4
        
      - name: ‚òï –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'
          
      - name: üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ
        run: |
          echo "üéØ –°–±–æ—Ä–∫–∞: ${{ env.PLUGIN_NAME }} v${{ env.PLUGIN_VERSION }}"
          echo "üíª –û–°: ${{ matrix.os }}"
          echo "‚òï Java: ${{ matrix.java }}"
          echo "üìÖ –í—Ä–µ–º—è: $(date)"
          echo "üîó –ö–æ–º–º–∏—Ç: ${{ github.sha }}"
          
      - name: üßπ –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏
        run: mvn -B clean
        
      - name: üì¶ –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –∫–æ–¥
        run: mvn -B compile
        
      - name: üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: mvn -B dependency:tree
        
      - name: üõ†Ô∏è –°–æ–±–∏—Ä–∞–µ–º JAR
        run: mvn -B package -DskipTests
        
      - name: üìã –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É
        run: |
          JAR_FILE=$(find target -name "*.jar" ! -name "*-javadoc.jar" ! -name "original-*.jar" | head -1)
          if [ -f "$JAR_FILE" ]; then
            echo "‚úÖ –°–ë–û–†–ö–ê –£–°–ü–ï–®–ù–ê!"
            echo "üì¶ –§–∞–π–ª: $(basename $JAR_FILE)"
            echo "üìä –†–∞–∑–º–µ—Ä: $(du -h $JAR_FILE | cut -f1)"
            echo "üîç MD5: $(md5sum $JAR_FILE | cut -d' ' -f1)"
            echo "üìù –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–≥–∏–Ω–µ:"
            unzip -p "$JAR_FILE" plugin.yml | grep -E "(name|version|main|description)" | while read line; do
              echo "   $line"
            done
          else
            echo "‚ùå –°–±–æ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞!"
            exit 1
          fi

  quality:
    name: ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4
        
      - name: ‚òï –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
        run: |
          echo "üîç –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞..."
          echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
          find src/main/java -name "*.java" | wc -l | xargs echo "üìÅ Java —Ñ–∞–π–ª–æ–≤:"
          find src/main/resources -name "*.yml" | wc -l | xargs echo "üìÑ YAML —Ñ–∞–π–ª–æ–≤:"
          echo ""
          echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
          mvn -B compile > /dev/null 2>&1 && echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω" || echo "‚ùå –û—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏"

  artifacts:
    name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞
    runs-on: ubuntu-latest
    needs: [build, quality]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4
        
      - name: ‚òï –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: üèóÔ∏è –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞
        run: mvn -B clean package -DskipTests
        
      - name: üìÅ –ì–æ—Ç–æ–≤–∏–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
        run: |
          mkdir -p release
          JAR_FILE=$(find target -name "*.jar" ! -name "*-javadoc.jar" ! -name "original-*.jar" | head -1)
          cp "$JAR_FILE" release/
          cp -r src/main/resources/*.yml release/ 2>/dev/null || echo "–ö–æ–Ω—Ñ–∏–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
          
          # –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π README –¥–ª—è —Ä–µ–ª–∏–∑–∞
          cat > release/README.md << 'EOF'
# üöÄ OperatorFromPerms v2.0.0

## –ß—Ç–æ –Ω–æ–≤–æ–≥–æ:
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ "–ö–æ—à–∞—Ä–∞ 3000"
- üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥ —Å –ø–∞—Ä–æ–ª—è–º–∏
- üíæ –§—É–Ω–∫—Ü–∏—è "–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è" –Ω–∞ 24 —á–∞—Å–∞
- üéØ –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LuckPerms

## –ö–æ–º–∞–Ω–¥—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
- `/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è <–ø–∞—Ä–æ–ª—å> <–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ>` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `/–ª–æ–≥–∏–Ω <–ø–∞—Ä–æ–ª—å>` - –≤—Ö–æ–¥
- `/–∑–∞–ø–æ–º–Ω–∏—Ç—å` - –∑–∞–ø–æ–º–Ω–∏—Ç—å –Ω–∞ 24 —á–∞—Å–∞

## –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- `/opf reload` - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏
- `/opf check <–∏–≥—Ä–æ–∫>` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

## –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏:
- gordey25690
- DeepSeek
- –° –∏–¥–µ–µ–π –æ—Ç –ö–æ—à–∞—Ä–∞ 3000 üê±

> –°–æ–±—Ä–∞–Ω–æ: $(date)
> –ö–æ–º–º–∏—Ç: ${{ github.sha }}
EOF

      - name: üè∑Ô∏è –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
          tag_name: v2.0.0-${{ github.run_number }}
          name: "OperatorFromPerms v2.0.0 Build ${{ github.run_number }}"
          body: |
            ## üéâ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!
            
            ### –ß—Ç–æ –Ω–æ–≤–æ–≥–æ:
            - üîê **–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ "–ö–æ—à–∞—Ä–∞ 3000"**
            - üìù **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è** (/reg, /—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
            - üîë **–õ–æ–≥–∏–Ω** (/login, /–ª–æ–≥–∏–Ω)  
            - üíæ **–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è** –Ω–∞ 24 —á–∞—Å–∞
            - üéØ **–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —Å LuckPerms
            
            ### –ö–æ–º–∞–Ω–¥—ã:
            ```bash
            # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            /—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è <–ø–∞—Ä–æ–ª—å> <–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ>
            /–ª–æ–≥–∏–Ω <–ø–∞—Ä–æ–ª—å>
            /–∑–∞–ø–æ–º–Ω–∏—Ç—å
            
            # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            /opf reload
            /opf check <–∏–≥—Ä–æ–∫>
            ```
            
            ### –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏:
            - gordey25690
            - DeepSeek
            - –° –∏–¥–µ–µ–π –æ—Ç –ö–æ—à–∞—Ä–∞ 3000 üê±

  deploy:
    name: üöÄ –î–µ–ø–ª–æ–π
    runs-on: ubuntu-latest
    needs: artifacts
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        run: |
          echo "üéâ –°–ë–û–†–ö–ê #${{ github.run_number }} –ó–ê–í–ï–†–®–ï–ù–ê!"
          echo "üì¶ –†–ï–õ–ò–ó –°–û–ó–î–ê–ù: v2.0.0-${{ github.run_number }}"
          echo "üîó –°—Å—ã–ª–∫–∞: https://github.com/${{ github.repository }}/releases/tag/v2.0.0-${{ github.run_number }}"
          echo ""
          echo "üöÄ –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò:"
          echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ö–æ—à–∞—Ä–∞ 3000"
          echo "‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ª–æ–≥–∏–Ω"
          echo "‚úÖ –ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è –Ω–∞ 24 —á–∞—Å–∞"
          echo "‚úÖ –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LuckPerms"

  status:
    name: üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    runs-on: ubuntu-latest
    needs: [security-check, build, quality, artifacts, deploy]
    if: always()
    
    steps:
      - name: üìà –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        run: |
          echo "# üìä –û–¢–ß–ï–¢ –û –°–ë–û–†–ö–ï #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| –≠—Ç–∞–ø | –°—Ç–∞—Ç—É—Å |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ | ${{ needs.security-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üì¶ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ | ${{ needs.artifacts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üöÄ –î–µ–ø–ª–æ–π | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.artifacts.result }}" == "success" ]; then
            echo "## üéâ –£–°–ü–ï–•!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**OperatorFromPerms v2.0.0** —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üÜï –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:" >> $GITHUB_STEP_SUMMARY
            echo "- üîê –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ \"–ö–æ—à–∞—Ä–∞ 3000\"" >> $GITHUB_STEP_SUMMARY
            echo "- üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (/reg, /—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)" >> $GITHUB_STEP_SUMMARY
            echo "- üîë –õ–æ–≥–∏–Ω (/login, /–ª–æ–≥–∏–Ω)" >> $GITHUB_STEP_SUMMARY
            echo "- üíæ –ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è –Ω–∞ 24 —á–∞—Å–∞" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üì• –°–∫–∞—á–∞—Ç—å:" >> $GITHUB_STEP_SUMMARY
            echo "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [Releases](https://github.com/${{ github.repository }}/releases) —á—Ç–æ–±—ã —Å–∫–∞—á–∞—Ç—å –ø–ª–∞–≥–∏–Ω" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º" >> $GITHUB_STEP_SUMMARY
          fi
